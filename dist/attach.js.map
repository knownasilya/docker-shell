{"version":3,"sources":["../lib/attach.js"],"names":["attach","debug","container","started","logs","stream","stdin","stdout","stderr","then","streamc","reject","Error","start","spawn","bind","kill","remove","force","v","command","proc","write","JSON","stringify","type","Transform","transform","chunk","_","next","toString","push","demux","pipe","split","parse","mapSync","data","event","emit","code","unpipe"],"mappings":"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","file":"attach.js","sourcesContent":["import Bluebird from 'bluebird';\nimport { EventEmitter } from 'events';\nimport setupDebug from 'debug';\nimport es from 'event-stream';\nimport stream from 'stream';\nimport demuxer from './demuxer';\n\nconst debug = setupDebug('docker-shell:attach');\n\nexport default function attach(container, started) {\n  return container.attach({\n    logs: true,\n    stream: true,\n    stdin: true,\n    stdout: true,\n    stderr: true\n  }).then((streamc) => {\n    if (!streamc) return Bluebird.reject(new Error('Failed to attach container stream'));\n\n    if (!started) {\n      debug('starting container');\n      // start, and wait for it to be done\n      return container.start().then(() => {\n        debug('started container');\n/*\n        container.wait()\n          .then((res) => {\n            debug('done with container, success', res);\n            container.stop();\n          })\n          .catch((err) => {\n            debug('done with container, erred', err);\n            container.stop();\n          });\n*/\n      }).then(() => {\n        return {\n          spawn: spawn.bind(null, streamc),\n          kill,\n          container\n        };\n      });\n    }\n\n    return {\n      spawn: spawn.bind(null, streamc),\n      kill,\n      container\n    };\n  })\n\n  function kill() {\n    return container.remove({\n      force: true, // Stop container and remove\n      v: true // Remove any attached volumes\n    });\n  }\n\n  function spawn(streamc, command) {\n    const proc = new EventEmitter();\n\n    proc.kill = function () {\n      streamc.write(`${JSON.stringify({type: 'kill'})}\\n`);\n    };\n    proc.stdout = new stream.Transform({\n      transform(chunk, _, next) {\n        debug('proc.stdout', chunk.toString());\n        this.push(chunk);\n        next();\n      }\n    });\n    proc.stderr = new stream.Transform({\n      transform(chunk, _, next) {\n        debug('proc.stderr', chunk.toString());\n        this.push(chunk);\n        next();\n      }\n    });\n    proc.stdin = streamc;\n\n    var stdout = new stream.Transform({\n      transform(chunk, _, next) {\n        debug('stdout', chunk.toString());\n        this.push(chunk);\n        next();\n      }\n    });\n    var stderr = new stream.Transform({\n      transform(chunk, _, next) {\n        debug('stderr', chunk.toString());\n        this.push(chunk);\n        next();\n      }\n    });\n    const demux = demuxer(streamc, stdout, stderr);\n    stderr\n      .pipe(es.split())\n      .pipe(es.parse())\n      .pipe(es.mapSync(function (data) {\n        debug('got an err event', data);\n      }));\n\n    stdout\n      .pipe(es.split())\n      .pipe(es.parse())\n      .pipe(es.mapSync(function (data) {\n        debug('got an event', data);\n        if (data.event === 'stdout') {\n          proc.stdout.write(data.data);\n        }\n        if (data.event === 'stderr') {\n          proc.stderr.write(data.data);\n        }\n        if (data.event === 'exit') {\n          proc.emit('exit', data.code);\n          streamc.unpipe(demux);\n          stdout.unpipe();\n        }\n      }));\n\n    debug('running command', command);\n\n    //setTimeout(function() {\n      //streamc.write(`${JSON.stringify({command: command, args: args, type: 'start'})}\\n`);\n      streamc.write(command);\n    //}, 500);\n\n    return proc;\n  }\n}\n"]}